<html>
    <head>
        <meta charset="UTF-8" />
        <script src="js/main.js"></script>
        <script src="js/GPXParser.min.js"></script>
        <script type="text/javascript">
            function load_gpx(filename) {
                const xhttp = new XMLHttpRequest();
                xhttp.open("GET", filename, false);
                xhttp.send();

                var gpx = new gpxParser(); //Create gpxParser Object
                gpx.parse(xhttp.responseText);
                return gpx;
            }

            function fill_elements() {
                // get query arguments            
                var $_GET = parse_args();

                if (!valid_get_args($_GET)) {
                    document.getElementById("title").innerHTML = "Suivi de coureur sur une trace GPX (HTML/JS only)" +
                        " : vous devez passer les arguments <code>lat</code>, <code>lon</code> et <code>track</code>";
                    return;
                }
                var url = "gpx/" + $_GET["track"] + ".gpx";
                var track_id = 0;   // TODO: could be passed as arg maybe?
                
                document.getElementById("title").innerHTML = "Suivi de coureur sur la trace <code>" + url + "</code>";

                var gpx_o = load_gpx(url);
                
                const track = gpx_o.tracks[0];

                document.getElementById("track_name").innerHTML = track.name;
                document.getElementById("track_length").innerHTML = "(" + Math.round(track.distance.total / 1000) + "km)";
                
                d_opt = Math.round(distance_covered_second_half($_GET["lat"], $_GET["lon"], track) / 1000);
                d_pess = Math.round(distance_covered_first_half($_GET["lat"], $_GET["lon"], track) / 1000);
                document.getElementById("opt_dist_parcourue").innerHTML = d_opt + "km";
                document.getElementById("pess_dist_parcourue").innerHTML = d_pess + "km";

                if (!Object.keys($_GET).includes("start_timestamp")) {
                    for (span_id of Array("temps_ecoule", "opt_temps_restant", "pess_temps_restant")) {
                        document.getElementById(span_id).innerHTML = "NaN (heure de début <code>start_timestamp</code> non fournie)";
                    }
                } else {
                    var elapsed = (Date.now() - $_GET["start_timestamp"]) / 1000;
                    var elapsed_h = Math.floor(elapsed / 3600);
                    var elapsed_m = Math.floor(elapsed / 60) % 60;
                    var elapsed_s = Math.round(elapsed % 60);
                    console.log(Date(Date.now()));
                    console.log(Date($_GET["start_timestamp"]));
                    document.getElementById("temps_ecoule").innerHTML = elapsed_h + "h " + elapsed_m + "m " + elapsed_s + "s";
                }
            }
        </script>
    </head>
    <body onload="fill_elements()">
        <h1 id="title"></h1>

        <div id="found_tracks">
            <h2>Track: <span id="track_name"></span> <span id="track_length"></span></h2>

            <p>Temps écoulé: <span id="temps_ecoule"></span></p>

            <h3>Version optimiste (les coureurs ont dépassé la mi-course)</h3>

            <ul>
                <li>Distance parcourue: <span id="opt_dist_parcourue"></span></li>
                <li>Temps restant (estimé): <span id="opt_temps_restant"></span></li>
            </ul>

            <h3>Version pessimiste (les coureurs sont encore dans la première moitié de course)</h3>

            <ul>
                <li>Distance parcourue: <span id="pess_dist_parcourue"></span></li>
                <li>Temps restant (estimé): <span id="pess_temps_restant"></span></li>
            </ul>
        </div>
    </body>
</html>